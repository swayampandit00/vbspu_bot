<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - VBSPU Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: block;
            padding: 12px 20px;
            color: #2c3e50;
            text-decoration: none;
            transition: background 0.3s;
            font-size: 14px;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: #667eea;
            color: white;
        }

        .main-content {
            flex: 1;
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-card.primary {
            border-top: 4px solid #3498db;
        }

        .stat-card.success {
            border-top: 4px solid #27ae60;
        }

        .stat-card.warning {
            border-top: 4px solid #f39c12;
        }

        .stat-card.danger {
            border-top: 4px solid #e74c3c;
        }

        .content-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: #2c3e50;
            font-size: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ VBSPU Bot Admin Panel</h1>
        <div class="header-actions">
            <span>Welcome, <span id="adminName">Admin</span></span>
            <a href="/admin/logout" class="logout-btn">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#dashboard" class="menu-item active" data-section="dashboard">üìä Dashboard</a></li>
                <li><a href="#scraping" class="menu-item" data-section="scraping">üîÑ Data Scraping</a></li>
                <li><a href="#settings" class="menu-item" data-section="settings">‚öôÔ∏è Bot Settings</a></li>
                <li><a href="#users" class="menu-item" data-section="users">üë• Users</a></li>
                <li><a href="#logs" class="menu-item" data-section="logs">üìù Admin Logs</a></li>
                <li><a href="#chat-history" class="menu-item" data-section="chat-history">üí¨ Chat History</a></li>
            </ul>
        </div>

        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="content-section">
                <div class="section-header">
                    <h2>Dashboard Overview</h2>
                    <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ Refresh</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card primary">
                        <h3>Total Users</h3>
                        <div class="number" id="totalUsers">-</div>
                    </div>
                    <div class="stat-card success">
                        <h3>Total Chats</h3>
                        <div class="number" id="totalChats">-</div>
                    </div>
                    <div class="stat-card warning">
                        <h3>Data Last Updated</h3>
                        <div class="number" id="lastUpdated">-</div>
                    </div>
                    <div class="stat-card danger">
                        <h3>Bot Status</h3>
                        <div class="number" id="botStatus">Active</div>
                    </div>
                </div>
            </div>

            <!-- Data Scraping Section -->
            <div id="scraping-section" class="content-section hidden">
                <div class="section-header">
                    <h2>Data Scraping Management</h2>
                    <button class="btn btn-success" onclick="startScraping()">üöÄ Start Scraping</button>
                </div>

                <div id="scrapingAlert"></div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Last Updated</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="scrapingTableBody">
                        <tr>
                            <td colspan="4" class="loading">
                                <div class="spinner"></div>
                                Loading scraping data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Bot Settings Section -->
            <div id="settings-section" class="content-section hidden">
                <div class="section-header">
                    <h2>Bot Settings</h2>
                    <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
                </div>

                <div id="settingsAlert"></div>

                <form id="settingsForm">
                    <div class="form-group">
                        <label for="botName">Bot Name</label>
                        <input type="text" id="botName" name="botName">
                    </div>

                    <div class="form-group">
                        <label for="welcomeMessage">Welcome Message</label>
                        <textarea id="welcomeMessage" name="welcomeMessage" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="offTopicResponse">Off-Topic Response</label>
                        <textarea id="offTopicResponse" name="offTopicResponse" rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="maxResponseLength">Max Response Length</label>
                        <input type="number" id="maxResponseLength" name="maxResponseLength">
                    </div>

                    <div class="form-group">
                        <label for="autoScrapeInterval">Auto Scrape Interval (seconds)</label>
                        <input type="number" id="autoScrapeInterval" name="autoScrapeInterval">
                    </div>
                </form>
            </div>

            <!-- Users Section -->
            <div id="users-section" class="content-section hidden">
                <div class="section-header">
                    <h2>User Management</h2>
                    <button class="btn btn-success" onclick="addUser()">‚ûï Add User</button>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="spinner"></div>
                                Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Admin Logs Section -->
            <div id="logs-section" class="content-section hidden">
                <div class="section-header">
                    <h2>Admin Activity Logs</h2>
                    <button class="btn btn-primary" onclick="refreshLogs()">üîÑ Refresh</button>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Admin</th>
                            <th>Action</th>
                            <th>Details</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <tr>
                            <td colspan="4" class="loading">
                                <div class="spinner"></div>
                                Loading logs...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Chat History Section -->
            <div id="chat-history-section" class="content-section hidden">
                <div class="section-header">
                    <h2>Chat History</h2>
                    <button class="btn btn-primary" onclick="refreshChatHistory()">üîÑ Refresh</button>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>User Message</th>
                            <th>Bot Response</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="chatHistoryTableBody">
                        <tr>
                            <td colspan="3" class="loading">
                                <div class="spinner"></div>
                                Loading chat history...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentSection = 'dashboard';
        
        // Menu navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.dataset.section;
                showSection(section);
            });
        });

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(`${section}-section`).classList.remove('hidden');
            
            // Update active menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            
            currentSection = section;
            
            // Load section data
            loadSectionData(section);
        }

        function loadSectionData(section) {
            switch(section) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'scraping':
                    loadScrapingData();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'logs':
                    loadLogs();
                    break;
                case 'chat-history':
                    loadChatHistory();
                    break;
            }
        }

        async function loadDashboardData() {
            try {
                const response = await fetch('/admin/api/dashboard');
                const data = await response.json();
                
                document.getElementById('totalUsers').textContent = data.total_users || '0';
                document.getElementById('totalChats').textContent = data.total_chats || '0';
                document.getElementById('lastUpdated').textContent = data.data_last_updated || 'Never';
                document.getElementById('botStatus').textContent = data.bot_status || 'Unknown';
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadScrapingData() {
            try {
                const response = await fetch('/admin/api/scraping-status');
                const data = await response.json();
                
                const tbody = document.getElementById('scrapingTableBody');
                tbody.innerHTML = '';
                
                if (data.categories && data.categories.length > 0) {
                    data.categories.forEach(category => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${category}</td>
                            <td>${data.last_updated || 'Never'}</td>
                            <td><span class="status-badge status-active">Available</span></td>
                            <td>
                                <button class="btn btn-primary" onclick="scrapeCategory('${category}')">Scrape Now</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No scraping data available. Click "Scrape All Data" to start.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading scraping data:', error);
                const tbody = document.getElementById('scrapingTableBody');
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: red;">Error loading data. Please try again.</td></tr>';
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch('/admin/api/settings');
                const data = await response.json();
                
                Object.entries(data).forEach(([key, setting]) => {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = setting.value;
                    }
                });
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/admin/api/users');
                const users = await response.json();
                
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                
                if (users && users.length > 0) {
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.id || 'N/A'}</td>
                            <td>${user.username || 'N/A'}</td>
                            <td>${user.email || 'N/A'}</td>
                            <td><span class="role-badge role-${user.role || 'user'}">${user.role || 'user'}</span></td>
                            <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <button class="btn btn-warning" onclick="editUser(${user.id})">Edit</button>
                                <button class="btn btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No users found.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">Error loading users. Please try again.</td></tr>';
            }
        }

        async function loadLogs() {
            try {
                const response = await fetch('/admin/api/logs');
                const logs = await response.json();
                
                const tbody = document.getElementById('logsTableBody');
                tbody.innerHTML = '';
                
                if (logs && logs.length > 0) {
                    logs.forEach(log => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${log.admin_username || 'Admin'}</td>
                            <td>${log.action || 'Unknown'}</td>
                            <td>${log.details || '-'}</td>
                            <td>${log.timestamp ? new Date(log.timestamp).toLocaleString() : 'N/A'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No logs found.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                const tbody = document.getElementById('logsTableBody');
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: red;">Error loading logs. Please try again.</td></tr>';
            }
        }

        async function loadChatHistory() {
            try {
                const response = await fetch('/admin/api/chat-history');
                const chats = await response.json();
                
                const tbody = document.getElementById('chatHistoryTableBody');
                tbody.innerHTML = '';
                
                if (chats && chats.length > 0) {
                    chats.forEach(chat => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${chat.user_message ? (chat.user_message.substring(0, 50) + (chat.user_message.length > 50 ? '...' : '')) : 'N/A'}</td>
                            <td>${chat.bot_response ? (chat.bot_response.substring(0, 50) + (chat.bot_response.length > 50 ? '...' : '')) : 'N/A'}</td>
                            <td>${chat.timestamp ? new Date(chat.timestamp).toLocaleString() : 'N/A'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">No chat history found.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                const tbody = document.getElementById('chatHistoryTableBody');
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: red;">Error loading chat history. Please try again.</td></tr>';
            }
        }

        async function startScraping() {
            showAlert('scrapingAlert', 'Starting scraping process...', 'success');
            
            try {
                const response = await fetch('/admin/api/scrape-all', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('scrapingAlert', 'Scraping completed successfully!', 'success');
                    loadScrapingData();
                } else {
                    showAlert('scrapingAlert', data.error || 'Scraping failed', 'error');
                }
            } catch (error) {
                showAlert('scrapingAlert', 'Network error during scraping', 'error');
            }
        }

        async function saveSettings() {
            const formData = new FormData(document.getElementById('settingsForm'));
            const settings = {};
            
            for (let [key, value] of formData.entries()) {
                settings[key] = value;
            }
            
            try {
                const response = await fetch('/admin/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('settingsAlert', 'Settings saved successfully!', 'success');
                } else {
                    showAlert('settingsAlert', data.error || 'Failed to save settings', 'error');
                }
            } catch (error) {
                showAlert('settingsAlert', 'Network error', 'error');
            }
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function refreshDashboard() {
            loadDashboardData();
        }

        function refreshLogs() {
            loadLogs();
        }

        function refreshChatHistory() {
            loadChatHistory();
        }

        function addUser() {
            // Redirect to add user page
            window.location.href = '/admin/add-user';
        }

        function editUser(userId) {
            // Redirect to edit user page
            window.location.href = `/admin/edit-user/${userId}`;
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                // Call delete API
                fetch(`/admin/api/users/${userId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('User deleted successfully');
                            loadUsers();
                        } else {
                            alert('Failed to delete user');
                        }
                    })
                    .catch(error => {
                        alert('Error deleting user');
                    });
            }
        }

        // Load initial dashboard data
        loadDashboardData();
    </script>
</body>
</html>
